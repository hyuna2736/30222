import json
import ast

# 1. ê¸°ë³¸ êµ¬ì¡° ì˜ˆì¸¡ ë£°
helix_formers = ['A', 'L', 'M', 'Q', 'E', 'K', 'H']
sheet_formers = ['V', 'I', 'Y', 'F', 'W', 'T']
coil_formers  = ['G', 'P', 'S', 'D', 'N']

# 2. JSONì—ì„œ ìœ ì „ ì§ˆí™˜ ì—°ê´€ ë³€ì´ ë¡œë“œ
def load_disease_db(filepath):
    with open(filepath, 'r', encoding='utf-8') as f:
        raw_data = json.load(f)
    # ë¬¸ìì—´ í‚¤ë¥¼ ì‹¤ì œ íŠœí”Œë¡œ ë³€í™˜
    disease_db = {ast.literal_eval(key): value for key, value in raw_data.items()}
    return disease_db

# 3. êµ¬ì¡° ì˜ˆì¸¡ í•¨ìˆ˜
def predict_secondary_structure(seq):
    structure = []
    for aa in seq:
        if aa in helix_formers:
            structure.append("H")
        elif aa in sheet_formers:
            structure.append("E")
        else:
            structure.append("C")
    return ''.join(structure)

# 4. ë³€ì´ ë¹„êµ í•¨ìˆ˜
def compare_sequences(seq1, seq2):
    if len(seq1) != len(seq2):
        raise ValueError("ì„œì—´ ê¸¸ì´ê°€ ë‹¤ë¦…ë‹ˆë‹¤. ë¹„êµí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    mutations = []
    for i, (aa1, aa2) in enumerate(zip(seq1, seq2), start=1):
        if aa1 != aa2:
            mutations.append((i, aa1, aa2))
    return mutations

# 5. ì§ˆë³‘ ì—°ê´€ í™•ì¸
def check_disease_links(mutations, disease_db):
    related = []
    for pos, orig, mut in mutations:
        key = (pos, orig, mut)
        if key in disease_db:
            related.append((pos, disease_db[key]))
    return related

# 6. ê²°ê³¼ ì¶œë ¥
def print_results(seq1, seq2, struct1, struct2, mutations, disease_links):
    print("\nğŸ”¬ ì›ë³¸ ì„œì—´:     ", seq1)
    print("ğŸ§¬ ë¹„êµ ì„œì—´:     ", seq2)
    print("ğŸ“ˆ êµ¬ì¡° ì˜ˆì¸¡(ì›ë³¸):", struct1)
    print("ğŸ“‰ êµ¬ì¡° ì˜ˆì¸¡(ë¹„êµ):", struct2)

    if mutations:
        print("\nğŸ” ë³€ì´ëœ ìœ„ì¹˜:")
        for pos, orig, mut in mutations:
            print(f" - {pos}ë²ˆì§¸: {orig} â†’ {mut}")
        print("\nğŸ“Œ êµ¬ì¡° ë³€í™” ìœ„ì¹˜:")
        diff = [" " if a == b else "^" for a, b in zip(struct1, struct2)]
        print("                     " + "".join(diff))
    else:
        print("\nâœ… ë‘ ì„œì—´ì€ ì™„ì „íˆ ë™ì¼í•©ë‹ˆë‹¤. ë³€ì´ê°€ ì—†ìŠµë‹ˆë‹¤.")

    if disease_links:
        print("\nâš ï¸ ìœ ì „ ì§ˆí™˜ ì—°ê´€ ë³€ì´ ë°œê²¬:")
        for pos, info in disease_links:
            print(f" - {pos}ë²ˆì§¸ ë³€ì´ â†’ ê´€ë ¨ ì§ˆí™˜: {info['name']}")
            print("   ğŸ©º ê°„í˜¸ ì¤‘ì¬ ì˜ˆì‹œ:")
            for note in info["notes"]:
                print("     â€¢", note)
    else:
        print("\nâœ… í˜„ì¬ê¹Œì§€ ì•Œë ¤ì§„ ìœ ì „ ì§ˆí™˜ê³¼ ê´€ë ¨ëœ ë³€ì´ëŠ” ì—†ìŠµë‹ˆë‹¤.")

# ë©”ì¸ ì‹¤í–‰
if __name__ == "__main__":
    print("ğŸ’¡ ì•„ë¯¸ë…¸ì‚° ì„œì—´ ê¸¸ì´ëŠ” ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.")
    seq1 = input("ğŸ”¡ ì›ë³¸ ì•„ë¯¸ë…¸ì‚° ì„œì—´ì„ ì…ë ¥í•˜ì„¸ìš”: ").strip().upper()
    seq2 = input("ğŸ”¡ ë¹„êµí•  ì•„ë¯¸ë…¸ì‚° ì„œì—´ì„ ì…ë ¥í•˜ì„¸ìš”: ").strip().upper()

    try:
        disease_db = load_disease_db("mutation_data.json")
        struct1 = predict_secondary_structure(seq1)
        struct2 = predict_secondary_structure(seq2)
        mutations = compare_sequences(seq1, seq2)
        disease_links = check_disease_links(mutations, disease_db)

        print_results(seq1, seq2, struct1, struct2, mutations, disease_links)

    except ValueError as e:
        print("âš ï¸ ì˜¤ë¥˜:", e)
    except FileNotFoundError:
        print("âš ï¸ 'mutation_data.json' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë™ì¼í•œ í´ë”ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.")
